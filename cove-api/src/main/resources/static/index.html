<!doctype html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="/asset/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/asset/style.css">
    <link rel="stylesheet" type="text/css" href="/asset/uppy/uppy.min.css">
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.14&key=6b87d1d3817e5b1c59b8a646300c4b25"></script>
    <title>发现世界</title>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-md navbar-dark color-bg-first">
            <a class="navbar-brand" href="#">
                <img src="/asset/img/logo_40_40.png" />发现世界
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">首页 <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">附近</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">发现</a>
                    </li>
                </ul>
                <ul class="navbar-nav right">
                    <li class="nav-item">
                        <a class="nav-link" href="javascript:openUpload();">上传</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">我的</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main role="main">
        <div id="container"></div>
    </main>

    <div class="mark" id="markUpload" style="display: none">
        <div class="card-body" id="fileUpload">
        </div>
    </div>

    <script src="/asset/http/fetch.js" type="module"></script>
    <script src="/asset/uppy/uppy.min.js"></script>
    <script src="/asset/uppy/uppy.zh_CN.min.js"></script>

    <script>
        AMap.plugin('AMap.ToolBar', function() {
            var toolbar = new AMap.ToolBar();
            map.addControl(toolbar)
        });
        AMap.plugin('AMap.Geolocation', function() {
            geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 10000,
                showMarker: false,
                showCircle: false,
            });
            geolocation.getCurrentPosition();
            AMap.event.addListener(geolocation, 'complete', function(result) {
                console.log('定位成功');
                map.center(result.position);
            });
            AMap.event.addListener(geolocation, 'error', function(result) {
                console.log('定位失败');
            });
        });

        var map = new AMap.Map('container', {
            resizeEnable: true,
            zoom: 11,
        });

        // 获取范围
        function loadMapBounds() {
            var bounds = map.getBounds();
            return {
                minLatitude: bounds.southwest.lat,
                minLongitude: bounds.southwest.lng,
                maxLatitude: bounds.northeast.lat,
                maxLongitude: bounds.northeast.lng,
            }
        }

        // 上传
        var uppy = Uppy.Core({
                debug: true,
                autoProceed: false,
                restrictions: {
                    maxFileSize: 10000000,
                    maxNumberOfFiles: 10,
                    allowedFileTypes: ['image/*']
                },
                locale: Uppy.locales.zh_CN
            })
            .use(Uppy.Dashboard, {
                inline: true,
                target: '#fileUpload',
                replaceTargetContent: true,
                showProgressDetails: true,
                note: '只允许上传图片, 最多10个文件，最大10M',
                height: 470,
                metaFields: [{
                    id: 'name',
                    name: '名称',
                    placeholder: '文件名称'
                }],
                browserBackButtonClose: true
            })
            .use(Uppy.XHRUpload, {
                fieldName: 'file',
                endpoint: '/story/cute'
            });

        uppy.on("complete", (result) => {
            console.log('上传完成!');
            document.getElementById("markUpload").style.display = "none";
        });

        // 打开上传
        function openUpload() {
            document.getElementById("markUpload").style.display = "block";
        }

        // 获取故事
        function loadStory() {
            let bounds = loadMapBounds();
            let url = '/story/near?';
            Object.keys(bounds).forEach(function(key) {
                url = url + key + "=" + bounds[key] + "&";
            });

            fetch(url, {
                    mode: 'cors'
                })
                .then(function(response) {
                    response.json().then(function(json) {
                        var list = json.data;
                        for (var i = 0; i < list.length; i++) {
                            var story = list[i];
                            story.url = story.url.replace('\\', '/');
                            var dot = story.url.lastIndexOf('.');
                            story.icon = story.url.substring(0,dot)+"_t"+story.url.substring(dot);

                            var mrkContent = `<div class="marker"><img class="orange" src="file/download?name=${story.icon}" /></div>`;
                            var marker = new AMap.Marker({
                                content: mrkContent,
                                map: map,
                                title: story.name,
                                position: new AMap.LngLat(story.longitude, story.latitude),
                            });
                            // 信息窗体的内容

                            var infoContent = `<div><img style='width:200px;height:100%;' src="file/download?name=${story.url}"><br><div>${story.description}</div></div>`;
                            // 创建 infoWindow 实例	
                            var infoWindow = new AMap.InfoWindow({
                                content: infoContent,
                                anchor: 'bottom-center',
                                offset: new AMap.Pixel(12, -24)
                            });
                            marker.on('click', function() {
                                infoWindow.open(map, [story.longitude, story.latitude]);
                            });
                        }
                    });
                })
        }

        map.on('moveend', loadStory);
    </script>

</body>

</html>