<!doctype html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" type="text/css" href="/asset/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/asset/uppy/uppy.min.css">
    <link rel="stylesheet" type="text/css" href="/asset/viewer/viewer.min.css">
    <link rel="stylesheet" type="text/css" href="/asset/style.css">
    <script type="text/javascript"
            src="http://webapi.amap.com/maps?v=1.4.14&key=6b87d1d3817e5b1c59b8a646300c4b25"></script>
    <title>发现世界</title>
</head>

<body>
<header>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top  color-bg-first">
        <a class="navbar-brand" href="#">
            <img src="/asset/img/logo_40_40.png"/>发现世界
        </a>
        <div class="navbar-toggler">

            <ul class="navbar-nav right">
                <li class="nav-item">
                    <a class="nav-link active" href="javascript:openUpload();">上传</a>
                </li>

            </ul>
        </div>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">附近</a>
                </li>
            </ul>
            <ul class="navbar-nav right">
                <li class="nav-item">
                    <a class="nav-link active" href="javascript:openUpload();">上传</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">登录</a>
                </li>
            </ul>
        </div>
    </nav>
</header>

<main role="main">
    <div id="container"></div>
</main>

<div class="mark" id="markUpload" style="display: none">
    <div class="mark-body" id="fileUpload">
    </div>
    <div class="mark-footer">
        <button class="btn btn-sm text-right" onclick="clearUpload()">重置</button>
        <button class="btn btn-sm text-right" onclick="closeUpload()">关闭</button>
    </div>
</div>

<script src="/asset/utils/fetch.js" type="module"></script>
<script src="/asset/utils/lodash.min.js"></script>
<script src="/asset/utils/moment.min.js"></script>
<script src="/asset/uppy/uppy.min.js"></script>
<script src="/asset/uppy/uppy.zh_CN.min.js"></script>
<script src="/asset/utils/coordtransform.js"></script>
<script src="/asset/viewer/viewer.min.js"></script>

<script>
        var map = new AMap.Map('container', {
            resizeEnable: true,
            zoom: 11,
        });
        AMap.plugin('AMap.ToolBar', function() {
            var toolbar = new AMap.ToolBar({
                offset:new AMap.Pixel(0,80),
                position:'LT'
            });
            map.addControl(toolbar)
        });
        AMap.plugin('AMap.Geolocation', function() {
            geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 10000,
                showMarker: true,
                showCircle: false,
            });
            geolocation.getCurrentPosition();
            AMap.event.addListener(geolocation, 'complete', function(result) {
                console.log('定位成功');
                map.setCenter(result.position);
            });
            AMap.event.addListener(geolocation, 'error', function(result) {
                console.log('定位失败');
            });
        });



        // 获取范围
        function loadMapBounds() {
            var bounds = map.getBounds();
            var min = coordtransform.gcj02towgs84(bounds.southwest.lng, bounds.southwest.lat);
            var max = coordtransform.gcj02towgs84(bounds.northeast.lng, bounds.northeast.lat);

            return {
                minLatitude: min[1],
                minLongitude: min[0],
                maxLatitude: max[1],
                maxLongitude: max[0],
            }
        }

        // 上传
        var uppy = Uppy.Core({
                debug: true,
                autoProceed: false,
                restrictions: {
                    maxFileSize: 10000000,
                    maxNumberOfFiles: 10,
                    allowedFileTypes: ['image/*']
                },
                locale: Uppy.locales.zh_CN
            })
            .use(Uppy.Dashboard, {
                inline: true,
                target: '#fileUpload',
                replaceTargetContent: true,
                showProgressDetails: true,
                note: '只允许上传图片, 最多10个文件，最大10M',
                height: 470,
                metaFields: [{
                    id: 'name',
                    name: '名称',
                    placeholder: '文件名称'
                }],
                browserBackButtonClose: true
            })
            .use(Uppy.XHRUpload, {
                fieldName: 'file',
                endpoint: '/story/cute'
            });

        uppy.on("complete", (result) => {
            console.log('上传完成!');
            if(result.successful[0].response.body.code > 0){
                uppy.info(result.successful[0].response.body.message);
            } else {
                clearUpload();
                closeUpload();
            }
        });

        // 打开上传
        function openUpload() {
            document.getElementById("markUpload").style.display = "block";
        }
        function closeUpload(){
            document.getElementById("markUpload").style.display = "none";
        }
        function clearUpload(){
            uppy.reset();
        }

        var allStory = [];
        // 获取故事
        function loadStory() {
            let bounds = loadMapBounds();
            let url = '/story/near?';
            Object.keys(bounds).forEach(function(key) {
                url = url + key + "=" + bounds[key] + "&";
            });

            fetch(url, {
                    mode: 'cors'
                })
                .then(function(response) {
                    response.json().then(function(json) {
                        // 移除所有覆盖物
                        var stories = json.data;
                        photos = [];
                        var now = moment().subtract(1,'d');
                        for (var i = stories.length-1; i >= 0; i--) {
                            var story = stories[i];

                            // 查找是否存在
                            if(_.find(allStory, function(s){return s.id==story.id})){
                                continue;
                            }

                            var dot = story.url.lastIndexOf('.');
                            story.icon = "uploads/"+story.url.substring(0,dot)+"_t"+story.url.substring(dot);
                            story.url = "file/download?name="+story.url.replace('\\', '/');

                            // 坐标转换
                            var coordinate = coordtransform.wgs84togcj02(story.longitude, story.latitude);
                            story.longitude = coordinate[0];
                            story.latitude = coordinate[1];
                            allStory.push(story);

                            // 优先显示
                            var className = 'usual';
                            if(moment(story.takeTime, "YYYY-MM-DD HH:mm:ss").isAfter(now)){
                                className = 'prior';
                            }

                            var mrkContent = `<div class="marker"><img class="${className}" src="${story.icon}" /></div>`;
                            var marker = new AMap.Marker({
                                content: mrkContent,
                                map: map,
                                title: story.name,
                                position: new AMap.LngLat(story.longitude, story.latitude),
                            });
                            marker.id = i;
                            marker.on('click', function() {
                                var item = stories[this.id];
                                // 信息窗体的内容
                                var content = `<div><img style='width:200px;height:100%;' src="${item.url}"><br><div>${item.description}</div></div>`;
                                // 创建 infoWindow 实例
                                var info = new AMap.InfoWindow({
                                    content: content,
                                    anchor: 'bottom-center',
                                    offset: new AMap.Pixel(12, -24)
                                });

                                // info.open(map, [item.longitude, item.latitude]);
                                var image = new Image();
                                image.src = item.url;
                                var viewer = new Viewer(image, {
                                  navbar: false,
                                  toolbar: {
                                    zoomIn: 4,
                                    zoomOut: 4,
                                    oneToOne: 4,
                                    reset: 4,
                                    prev: 0,
                                    play: {
                                      show: 4,
                                      size: 'large',
                                    },
                                    next: 0,
                                    rotateLeft: 4,
                                    rotateRight: 4,
                                    flipHorizontal: 4,
                                    flipVertical: 4,
                                  },
                                  hidden: function () {
                                    viewer.destroy();
                                  },
                                });
                                viewer.show();
                            });
                        }
                    });
                })
        }

        map.on('moveend', loadStory);
</script>

</body>

</html>